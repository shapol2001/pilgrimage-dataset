<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrims Dataset — Interactive Visualizations</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

  <style>
    body { padding: 30px; }
    #chart, #network, #timeline { margin-top: 40px; }
  </style>
</head>
<body>
  <h2>Паломнические и путевые записки</h2>

  <table id="pilgrimsTable" class="display" style="width:100%"></table>

  <hr />

  <h4>Графики</h4>
  <button class="btn btn-primary m-1" onclick="plotByYear()">Публикации по годам</button>
  <button class="btn btn-primary m-1" onclick="plotByAuthor()">Активность авторов</button>

  <h4 class="mt-4">Сетевой граф авторов и журналов</h4>
  <button class="btn btn-secondary m-1" onclick="renderNetwork()">Показать сетевой граф</button>

  <h4 class="mt-4">Хронологическая лента</h4>
  <button class="btn btn-secondary m-1" onclick="plotTimeline()">Показать timeline</button>

  <div id="chart"></div>
  <div id="network" style="height:600px; border:1px solid #ccc;"></div>
  <div id="timeline" style="height:500px; border:1px solid #ccc;"></div>

  <!-- JQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- vis-network -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Загружаем CSV
    fetch("pilgrims.csv")
      .then(response => {
        if (!response.ok) throw new Error("CSV файл не найден: " + response.status);
        return response.text();
      })
      .then(csvText => {
        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false
        });
        window.pilgrimsData = parsed.data;

        console.log("Parsed data:", window.pilgrimsData);

        const headers = Object.keys(window.pilgrimsData[0] || {});
        $("#pilgrimsTable").DataTable({
          data: window.pilgrimsData.map(r => headers.map(h => r[h])),
          columns: headers.map(h => ({ title: h }))
        });

        // Построим сразу граф по годам
        plotByYear();
      })
      .catch(err => {
        console.error("Ошибка загрузки/парсинга CSV:", err);
        alert("Не удалось загрузить или распарсить CSV. Проверь путь и формат.");
      });

    function checkData() {
      if (!window.pilgrimsData || !window.pilgrimsData.length) {
        alert("Данные ещё не загружены или пусты!");
        return false;
      }
      return true;
    }

    // График публикаций по годам (по «Дата посещения Святой земли»)
    function plotByYear() {
      if (!checkData()) return;

      const counts = {};
      window.pilgrimsData.forEach(r => {
        const val = r["Дата посещения Святой земли"];
        if (!val) return;
        const year = val.toString().trim();
        if (!year) return;
        counts[year] = (counts[year] || 0) + 1;
      });

      const x = Object.keys(counts).sort();
      const y = x.map(k => counts[k]);

      Plotly.newPlot("chart", [{
        x: x,
        y: y,
        type: "bar"
      }], { title: "Публикации по годам" });
    }

    // Активность авторов
    function plotByAuthor() {
      if (!checkData()) return;

      const counts = {};
      window.pilgrimsData.forEach(r => {
        const author = r["Автор"];
        if (!author) return;
        const name = author.toString().trim();
        if (!name) return;
        counts[name] = (counts[name] || 0) + 1;
      });

      const x = Object.keys(counts);
      const y = x.map(k => counts[k]);

      Plotly.newPlot("на chart", [{
        x: x,
        y: y,
        type: "bar"
      }], { title: "Активность авторов" });
    }

    // Сетевой граф Автор ↔ Журнал
    function renderNetwork() {
      if (!checkData()) return;

      const nodes = [];
      const edges = [];
      const nodeSet = new Set();

      window.pilgrimsData.forEach(r => {
        const author = r["Автор"];
        const journal = r["Журнал"];
        if (!author || !journal) return;

        const a = author.toString().trim();
        const j = journal.toString().trim();
        if (!a || !j) return;

        if (!nodeSet.has(a)) {
          nodes.push({ id: a, label: a, shape: "dot", size: 25 });
          nodeSet.add(a);
        }
        if (!nodeSet.has(j)) {
          nodes.push({ id: j, label: j, shape: "square", size: 25 });
          nodeSet.add(j);
        }
        edges.push({ from: a, to: j });
      });

      console.log("Network nodes:", nodes);
      console.log("Network edges:", edges);

      const container = document.getElementById("network");
      const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
      const options = {
        physics: {
          enabled: true,
          barnesHut: {
            gravitationalConstant: -20000,
            centralGravity: 0.1,
            springLength: 120,
            springConstant: 0.05
          },
          stabilization: { iterations: 250 }
        },
        nodes: {
          font: { size: 16, color: "#000", face: "Arial" },
          borderWidth: 1
        },
        edges: {
          smooth: true,
          color: { color: "#555" }
        }
      };
      new vis.Network(container, data, options);
    }

    // Timeline публикаций (по «Дата издания» и «Название»)
    function plotTimeline() {
      if (!checkData()) return;

      const events = window.pilgrimsData
        .map(r => {
          const y = r["Дата издания"];
          const t = r["Название"];
          if (!y) return null;
          const year = parseInt(y.toString().trim(), 10);
          if (isNaN(year)) return null;
          return { year: year, title: t ? t.toString().replace(/\r?\n/g, " ").trim() : "" };
        })
        .filter(e => e);

      if (!events.length) {
        alert("Нет данных для timeline (поле «Дата издания» пустое).");
        return;
      }

      Plotly.newPlot("timeline", [{
        x: events.map(e => e.year),
        y: events.map(() => 1),
        text: events.map(e => e.title),
        mode: "markers",
        type: "scatter"
      }], {
        title: "Timeline публикаций",
        yaxis: { visible: false }
      });
    }
  </script>
</body>
</html>
