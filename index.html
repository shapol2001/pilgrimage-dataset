<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrims Dataset — Visualizations</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>

  <style>
    body { padding: 30px; }
    #chart, #network, #timeline { margin-top: 40px; }
    #network { height: 600px; border: 1px solid #aaa; }
    #timeline { height: 500px; border: 1px solid #aaa; }
    #metricsBox { margin-top:10px; font-weight:bold; }
  </style>
</head>

<body>
<h2>Паломнические и путевые записки</h2>

<table id="pilgrimsTable" class="display" style="width:100%"></table>

<hr/>

<!-- Графики -->
<h4>Графики</h4>
<button class="btn btn-primary m-1" onclick="plotByYear()">Публикации по годам</button>
<button class="btn btn-primary m-1" onclick="plotByAuthor()">Активность авторов</button>
<button class="btn btn-primary m-1" onclick="plotByColumn('Образование автора','Образование авторов')">Образование</button>
<button class="btn btn-primary m-1" onclick="plotByColumn('Род деятельности на момент публикации текста','Род деятельности')">Род деятельности</button>

<!-- Сетевой граф -->
<h4 class="mt-4">Сетевой граф авторов и журналов</h4>
<button class="btn btn-success m-1" onclick="renderNetwork()">Показать сетевой граф</button>
<div id="metricsBox"></div>

<!-- Timeline -->
<h4 class="mt-4">Хронологическая лента</h4>
<button class="btn btn-success m-1" onclick="plotTimeline()">Показать timeline</button>

<div id="chart"></div>
<div id="network"></div>
<div id="timeline"></div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* =======================
   ЗАГРУЗКА CSV
======================= */
fetch("pilgrims.csv")
  .then(r => r.text())
  .then(text => {
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // BOM
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    window.pilgrimsData = parsed.data;

    const headers = Object.keys(pilgrimsData[0] || {});
    $("#pilgrimsTable").DataTable({
      data: pilgrimsData.map(row => headers.map(h => row[h] ?? "")),
      columns: headers.map(h => ({ title: h }))
    });

    plotByYear(); // график по умолчанию
  })
  .catch(err => {
    console.error("Ошибка загрузки CSV:", err);
    alert("Не удалось загрузить pilgrims.csv");
  });

function checkData() {
  if (!window.pilgrimsData || pilgrimsData.length === 0) {
    alert("Данные не загружены!");
    return false;
  }
  return true;
}

/* =======================
   ГРАФИК: ПУБЛИКАЦИИ ПО ГОДАМ
======================= */
function plotByYear() {
  if (!checkData()) return;
  const counts = {};
  pilgrimsData.forEach(r => {
    let y = r["Дата издания"];
    if (!y) return;
    y = y.toString().trim().replace(/[^\d]/g,"");
    if(y.length<3) return;
    const year = parseInt(y);
    if(isNaN(year)) return;
    counts[year] = (counts[year] || 0) + 1;
  });
  const years = Object.keys(counts).sort((a,b)=>a-b);
  const values = years.map(y=>counts[y]);
  Plotly.newPlot("chart", [{ x: years, y: values, type: "bar" }], { title: "Публикации по годам (Дата издания)" });
}

/* =======================
   ГРАФИК: АВТОРЫ
======================= */
function plotByAuthor() {
  if(!checkData()) return;
  const counts={};
  pilgrimsData.forEach(r=>{
    const a=r["Автор"];
    if(!a || a.toLowerCase() === "неизвестно") return;
    const author = a.trim();
    counts[author] = (counts[author]||0)+1;
  });
  Plotly.newPlot("chart",[{
    x: Object.keys(counts),
    y: Object.values(counts),
    type:"bar"
  }],{title:"Активность авторов"});
}

/* =======================
   ГРАФИК ПО ЛЮБОЙ КОЛОНКЕ
======================= */
function plotByColumn(colName,title){
  if(!checkData()) return;
  const counts={};
  pilgrimsData.forEach(r=>{
    const val=r[colName]?.trim();
    if(val && val.toLowerCase()!=="неизвестно") counts[val]=(counts[val]||0)+1;
  });
  Plotly.newPlot("chart",[{
    x:Object.keys(counts),
    y:Object.values(counts),
    type:"bar"
  }],{title});
}

/* =======================
   СЕТЕВОЙ ГРАФ
======================= */
function renderNetwork() {
  if (!checkData()) return;

  const nodes = [];
  const edges = [];
  const nodeMap = {};

  pilgrimsData.forEach(r=>{
    const author = r["Автор"]?.trim();
    const journal = r["Журнал"]?.trim();
    if(!author || !journal) return;
    if(author.toLowerCase() === "неизвестно" || journal.toLowerCase() === "неизвестно") return;

    if(!nodeMap[author]) nodeMap[author]={id:author,label:author,color:"red",type:"author",degree:0};
    if(!nodeMap[journal]) nodeMap[journal]={id:journal,label:journal,color:"blue",type:"journal",degree:0};

    nodeMap[author].degree++;
    nodeMap[journal].degree++;

    edges.push({from:author,to:journal});
  });

  for(let k in nodeMap){
    const n=nodeMap[k];
    n.size=15+n.degree*2;
    n.title=`${n.label}\nСвязей: ${n.degree}`;
    nodes.push(n);
  }

  const container = document.getElementById("network");
  container.innerHTML = ""; // очистка перед построением

  if(nodes.length===0 || edges.length===0){
    container.innerHTML="<p>Нет данных для отображения сети.</p>";
    document.getElementById("metricsBox").innerHTML="";
    return;
  }

  new vis.Network(
    container,
    { nodes:new vis.DataSet(nodes), edges:new vis.DataSet(edges) },
    { physics:{enabled:true,barnesHut:{gravitationalConstant:-30000,centralGravity:0.1,springLength:150,springConstant:0.02}}, edges:{color:"#555",smooth:true}, nodes:{font:{size:16}} }
  );

  // Метрики сети
  const totalNodes = nodes.length;
  const totalEdges = edges.length;
  const avgDegree = (totalEdges*2/totalNodes).toFixed(2);
  document.getElementById("metricsBox").innerHTML=`Узлов: ${totalNodes}, Связей: ${totalEdges}, Средняя степень: ${avgDegree}`;
}

/* =======================
   TIMELINE
======================= */
function plotTimeline() {
  if(!checkData()) return;

  const events=[];
  pilgrimsData.forEach(r=>{
    let y=r["Дата издания"];
    if(!y) return;
    y=y.toString().trim().replace(/[^\d]/g,"");
    if(y.length<3) return;
    const year=parseInt(y);
    if(isNaN(year)) return;

    events.push({ year:year, title:(r["Название"]||"").replace(/\s+/g," ") });
  });

  events.sort((a,b)=>a.year-b.year);

  const yvals={};
  const yData=events.map(e=>{
    if(!yvals[e.year]) yvals[e.year]=1;
    else yvals[e.year]++;
    return yvals[e.year];
  });

  Plotly.newPlot("timeline",[{
    x: events.map(e=>e.year),
    y: yData,
    text: events.map(e=>e.title),
    mode:"markers",
    type:"scatter",
    marker:{ size:12 }
  }],{
    title:"Timeline публикаций",
    yaxis:{ visible:false }
  });
}
</script>
</body>
</html>
