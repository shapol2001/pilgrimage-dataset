<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrims Dataset — Visualizations</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>

  <style>
    body { padding: 30px; }
    #network, #timeline, #chart { margin-top: 40px; }
    #network { height: 600px; border: 1px solid #aaa; }
    #timeline { height: 500px; border: 1px solid #aaa; }
  </style>
</head>

<body>
<h2>Паломнические и путевые записки</h2>

<table id="pilgrimsTable" class="display" style="width:100%"></table>

<hr/>

<h4>Графики</h4>
<button class="btn btn-primary m-1" onclick="plotByYear()">Публикации по годам</button>
<button class="btn btn-primary m-1" onclick="plotByAuthor()">Активность авторов</button>

<h4 class="mt-4">Сетевой граф авторов и журналов</h4>
<button class="btn btn-secondary m-1" onclick="renderNetwork()">Показать сетевой граф</button>

<h4 class="mt-4">Хронологическая лента</h4>
<button class="btn btn-secondary m-1" onclick="plotTimeline()">Показать timeline</button>

<div id="chart"></div>
<div id="network"></div>
<div id="timeline"></div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* =======================
   ЗАГРУЗКА CSV
   ======================= */

fetch("pilgrims.csv")
  .then(r => r.text())
  .then(text => {

    // Удаляем BOM, если есть
    if (text.charCodeAt(0) === 0xFEFF)
      text = text.slice(1);

    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });

    window.pilgrimsData = parsed.data;
    console.log("CSV загружен:", pilgrimsData);

    const headers = Object.keys(pilgrimsData[0]);

    $("#pilgrimsTable").DataTable({
      data: pilgrimsData.map(row => headers.map(h => row[h] ?? "")),
      columns: headers.map(h => ({ title: h }))
    });

    plotByYear();
  })
  .catch(err => {
    console.error("Ошибка загрузки CSV:", err);
    alert("Не удалось загрузить pilgrims.csv");
  });

function checkData() {
  if (!window.pilgrimsData || pilgrimsData.length === 0) {
    alert("Данные не загружены!");
    return false;
  }
  return true;
}

/* =======================
   ГРАФИК: ПУБЛИКАЦИИ ПО ГОДАМ
   ======================= */
function plotByYear() {
  if (!checkData()) return;

  const counts = {};
  pilgrimsData.forEach(r => {
    const y = r["Дата посещения Святой земли"];
    if (!y) return;
    const year = y.toString().trim();
    if (!year) return;
    counts[year] = (counts[year] || 0) + 1;
  });

  const years = Object.keys(counts).sort();
  const values = years.map(y => counts[y]);

  Plotly.newPlot("chart", [{
    x: years,
    y: values,
    type: "bar"
  }], { title: "Публикации по годам" });
}

/* =======================
   ГРАФИК: АВТОРЫ
   ======================= */
function plotByAuthor() {
  if (!checkData()) return;

  const counts = {};
  pilgrimsData.forEach(r => {
    const a = r["Автор"];
    if (!a) return;
    const author = a.trim();
    counts[author] = (counts[author] || 0) + 1;
  });

  Plotly.newPlot("chart", [{
    x: Object.keys(counts),
    y: Object.values(counts),
    type: "bar"
  }], { title: "Активность авторов" });
}

/* =======================
   СЕТЕВОЙ ГРАФ
   ======================= */
function renderNetwork() {
  if (!checkData()) return;

  const nodes = new vis.DataSet();
  const edges = new vis.DataSet();
  const added = new Set();

  pilgrimsData.forEach(r => {
    const a = r["Автор"]?.trim();
    const j = r["Журнал"]?.trim();
    if (!a || !j) return;

    if (!added.has(a)) {
      nodes.add({ id: a, label: a, shape: "dot", size: 20 });
      added.add(a);
    }
    if (!added.has(j)) {
      nodes.add({ id: j, label: j, shape: "square", size: 20 });
      added.add(j);
    }

    edges.add({ from: a, to: j });
  });

  new vis.Network(
    document.getElementById("network"),
    { nodes: nodes, edges: edges },
    {
      physics: { enabled: true },
      edges: { color: "#555" },
      nodes: { font: { size: 16 } }
    }
  );
}

/* =======================
   TIMELINE
   ======================= */
function plotTimeline() {
  if (!checkData()) return;

  const events = pilgrimsData.map(r => {
    let y = r["Дата издания"];
    if (!y) return null;

    // убрать мусор и переводы строк
    y = y.toString().trim().replace(/[^\d]/g, "");
    if (y.length < 3) return null;
    const year = parseInt(y);

    if (isNaN(year)) return null;

    return {
      year: year,
      title: (r["Название"] || "").replace(/\s+/g, " ")
    };
  }).filter(e => e);

  Plotly.newPlot("timeline", [{
    x: events.map(e => e.year),
    y: events.map(() => 1),
    text: events.map(e => e.title),
    mode: "markers",
    type: "scatter"
  }], {
    title: "Timeline публикаций",
    yaxis: { visible: false }
  });
}

</script>
</body>
</html>
