<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>База паломнических текстов</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.container { display: flex; flex-wrap: wrap; gap: 20px; }
#table-container { flex: 1 1 60%; min-width: 400px; }
#charts-container { flex: 1 1 35%; display: none; flex-direction: column; gap: 20px; }
canvas { width: 100% !important; height: 300px !important; }
button { margin-bottom: 10px; padding: 6px 12px; font-size: 14px; cursor: pointer; }
.dataTables_wrapper { margin-top: 20px; }
</style>
</head>
<body>

<h1>База паломнических текстов</h1>
<p>Данные берутся из <code>pilgrims.csv</code></p>

<button id="toggleCharts">Показать статистику</button>

<div class="container">
    <div id="table-container">
        <table id="pilgrimTable" class="display" style="width:100%"></table>
    </div>
    <div id="charts-container">
        <canvas id="chartYears"></canvas>
        <canvas id="chartRoles"></canvas>
        <canvas id="chartJournals"></canvas>
    </div>
</div>

<script>
let chartYears, chartRoles, chartJournals;

// Цвета для ролей (опционально)
const roleColors = {
    'архимандрит':'rgba(255, 99, 132, 0.6)',
    'протоирей':'rgba(54, 162, 235, 0.6)',
    'чиновник':'rgba(255, 206, 86, 0.6)'
};

// Построение графиков
function drawCharts(data) {
    function countField(arr, field) {
        const counts = {};
        arr.forEach(r => {
            let val = r[field];
            if (val) counts[val] = (counts[val] || 0) + 1;
        });
        return counts;
    }

    const countsYears = countField(data, 'Дата посещения Святой земли');
    const countsRoles = countField(data, 'Род деятельности на момент публикации текста');
    const countsJournals = countField(data, 'Журнал');

    function updateChart(chart, counts, label, colors=null) {
        chart.data.labels = Object.keys(counts);
        chart.data.datasets[0].data = Object.values(counts);
        chart.data.datasets[0].label = label;
        if(colors){
            chart.data.datasets[0].backgroundColor = Object.keys(counts).map(k => colors[k] || 'rgba(54, 162, 235, 0.6)');
        }
        chart.update();
    }

    if (!chartYears) {
        chartYears = new Chart(document.getElementById('chartYears').getContext('2d'), { type:'bar', data:{labels:[], datasets:[{label:'', data:[], backgroundColor:'rgba(54,162,235,0.6)'}]}, options:{responsive:true, maintainAspectRatio:false} });
    }
    if (!chartRoles) {
        chartRoles = new Chart(document.getElementById('chartRoles').getContext('2d'), { type:'bar', data:{labels:[], datasets:[{label:'', data:[], backgroundColor:[]}]}, options:{responsive:true, maintainAspectRatio:false} });
    }
    if (!chartJournals) {
        chartJournals = new Chart(document.getElementById('chartJournals').getContext('2d'), { type:'bar', data:{labels:[], datasets:[{label:'', data:[], backgroundColor:'rgba(255,159,64,0.6)'}]}, options:{responsive:true, maintainAspectRatio:false} });
    }

    updateChart(chartYears, countsYears, 'Количество записок');
    updateChart(chartRoles, countsRoles, 'Количество авторов', roleColors);
    updateChart(chartJournals, countsJournals, 'Количество записок');
}

// Переключение видимости графиков
document.getElementById('toggleCharts').addEventListener('click', function() {
    const container = document.getElementById('charts-container');
    if(container.style.display === 'none'){
        container.style.display = 'flex';
        this.textContent = 'Скрыть статистику';
    } else {
        container.style.display = 'none';
        this.textContent = 'Показать статистику';
    }
});

// Загружаем CSV через PapaParse
Papa.parse('pilgrims.csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        const data = results.data;

        const columns = Object.keys(data[0]).map(key => ({
            title: key,
            data: key,
            render: function(data, type, row){
                if(key==='Род деятельности на момент публикации текста'){
                    const color = roleColors[data] || 'inherit';
                    return `<span style="background-color:${color}; padding:2px 6px; border-radius:3px;">${data}</span>`;
                }
                return data;
            }
        }));

        const table = $('#pilgrimTable').DataTable({
            data: data,
            columns: columns,
            pageLength: 10,
            lengthMenu: [5,10,25,50],
            scrollX: true,
            initComplete: function () {
                drawCharts(data);
            }
        });

        // Обновляем графики при фильтре
        table.on('search.dt', function() {
            const filteredData = table.rows({filter:'applied'}).data().toArray();
            drawCharts(filteredData);
        });
    },
    error: function(err) {
        console.error('Ошибка загрузки CSV:', err);
    }
});
</script>

</body>
</html>
