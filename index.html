<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<title>Pilgrims Dataset — Visualizations</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>

<style>
  body { padding: 30px; }
  #chart, #networkChart, #timelineChart {
    margin-top: 20px; border: 1px solid #aaa; padding: 10px;
    min-height: 500px;
  }
  #metricsBox { margin-top: 10px; font-weight: bold; }
  .btn-line { display: flex; flex-wrap: wrap; gap:10px; margin-bottom:10px; }
</style>
</head>

<body>
<h2>Паломнические и путевые записки</h2>

<table id="pilgrimsTable" class="display" style="width:100%"></table>

<hr/>

<h4>Визуализации графиков</h4>
<div class="btn-line">
  <button class="btn btn-primary" onclick="plotByYear()">Публикации по годам</button>
  <button class="btn btn-primary" onclick="plotByAuthor()">Активность авторов</button>
  <button class="btn btn-primary" onclick="plotByColumn('Образование автора','Образование авторов')">Образование</button>
  <button class="btn btn-primary" onclick="plotByColumn('Род деятельности на момент публикации текста','Род деятельности')">Род деятельности</button>
  <button class="btn btn-primary" onclick="plotByColumn('Дата посещения Святой земли','Время событий')">Время событий</button>
</div>
<div id="chart"></div>

<h4>Сетевые графы</h4>
<div class="btn-line">
  <button class="btn btn-success" onclick="renderNetwork()">Сеть автор → журнал</button>
  <button class="btn btn-success" onclick="renderJournalSourceNetwork()">Сеть журнал → источник</button>
</div>
<div id="networkChart"></div>
<div id="metricsBox"></div>

<h4>Хронологическая лента</h4>
<div class="btn-line">
  <button class="btn btn-success" onclick="plotTimeline()">Показать Timeline</button>
</div>
<div id="timelineChart"></div>

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* =======================
   Загрузка CSV
======================= */
function loadCSV() {
  fetch("pilgrims.csv?nocache=" + new Date().getTime())
    .then(r=>r.text())
    .then(text=>{
      if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
      const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
      window.pilgrimsData = parsed.data.filter(r=>{
        // фильтр "Неизвестно/неизвестно"
        return !Object.values(r).some(v=>v?.trim().toLowerCase()==="неизвестно");
      });
      const headers = Object.keys(parsed.data[0]||{});

      if($.fn.DataTable.isDataTable('#pilgrimsTable')){
        const table = $('#pilgrimsTable').DataTable();
        table.clear();
        table.rows.add(window.pilgrimsData.map(r=>headers.map(h=>r[h]??"")));
        table.draw();
      } else {
        $("#pilgrimsTable").DataTable({
          data: window.pilgrimsData.map(r=>headers.map(h=>r[h]??"")),
          columns: headers.map(h=>({title:h}))
        });
      }
      plotByYear();
    })
    .catch(err=>{console.error(err); alert("Не удалось загрузить CSV.");});
}
loadCSV();

function checkData(){ if(!window.pilgrimsData || pilgrimsData.length===0){ alert("Данные не загружены!"); return false; } return true; }

/* =======================
   Графики
======================= */
function plotByYear(){
  if(!checkData()) return;
  const counts={};
  pilgrimsData.forEach(r=>{
    let y=r["Дата издания"];
    if(!y) return;
    y=y.toString().trim().replace(/[^\d]/g,"");
    if(y.length<3) return;
    const year=parseInt(y);
    if(isNaN(year)) return;
    counts[year]=(counts[year]||0)+1;
  });
  const years=Object.keys(counts).sort((a,b)=>a-b);
  const values=years.map(y=>counts[y]);
  Plotly.newPlot("chart",[ {x:years, y:values, type:"bar"} ],{ title:"Публикации по годам (Дата издания)"});
}

function plotByAuthor(){
  if(!checkData()) return;
  const counts={};
  pilgrimsData.forEach(r=>{
    const a=r["Автор"];
    if(!a) return;
    const author=a.trim();
    counts[author]=(counts[author]||0)+1;
  });
  Plotly.newPlot("chart",[ {x:Object.keys(counts),y:Object.values(counts),type:"bar"} ],{ title:"Активность авторов"});
}

function plotByColumn(colName,title){
  if(!checkData()) return;
  const counts={};
  pilgrimsData.forEach(r=>{
    const val=r[colName]?.trim();
    if(val && val.toLowerCase()!=="неизвестно") counts[val]=(counts[val]||0)+1;
  });
  Plotly.newPlot("chart",[ {x:Object.keys(counts),y:Object.values(counts),type:"bar"} ],{ title });
}

/* =======================
   Сети
======================= */
function renderNetwork(){
  if(!checkData()) return;
  const nodes=[], edges=[];
  const nodeMap={};
  pilgrimsData.forEach(r=>{
    const a=r["Автор"]?.trim();
    const j=r["Журнал"]?.trim();
    if(!a||!j) return;
    if(!nodeMap[a]) nodeMap[a]={id:a,label:a,color:"red",type:"author",degree:0,count:0};
    if(!nodeMap[j]) nodeMap[j]={id:j,label:j,color:"blue",type:"journal",degree:0,count:0};
    nodeMap[a].degree++; nodeMap[a].count++;
    nodeMap[j].degree++; nodeMap[j].count++;
    edges.push({from:a,to:j});
  });
  for(let k in nodeMap){
    const n=nodeMap[k];
    n.size=15+n.degree*2;
    n.title = `${n.label}\nПубликаций: ${n.count}`;
    nodes.push(n);
  }
  new vis.Network(
    document.getElementById("networkChart"),
    {nodes:new vis.DataSet(nodes),edges:new vis.DataSet(edges)},
    {physics:{enabled:true},edges:{color:"#555"},nodes:{font:{size:16}}}
  );

  // Метрики
  const totalNodes=nodes.length, totalEdges=edges.length;
  const avgDegree=(totalEdges*2/totalNodes).toFixed(2);
  document.getElementById("metricsBox").innerHTML=`Узлов: ${totalNodes}, Связей: ${totalEdges}, Средняя степень: ${avgDegree}`;
}

function renderJournalSourceNetwork(){
  if(!checkData()) return;
  const nodes=new vis.DataSet(), edges=new vis.DataSet();
  const added=new Set();
  pilgrimsData.forEach(r=>{
    const journal=r["Журнал"]?.trim();
    const source=r["Откуда перепечатан текст"]?.trim();
    if(!journal||!source) return;
    if(["Оригинальный","Не оригинальный","неизвестно","Неизвестно"].includes(source)) return;
    if(!added.has(journal)){ nodes.add({id:journal,label:journal,shape:"square",color:"blue",title:`Журнал: ${journal}`}); added.add(journal);}
    if(!added.has(source)){ nodes.add({id:source,label:source,shape:"dot",color:"orange",title:`Источник: ${source}`}); added.add(source);}
    edges.add({from:journal,to:source});
  });
  new vis.Network(document.getElementById("networkChart"),{nodes,edges},{physics:{enabled:true},edges:{color:"#555"},nodes:{font:{size:16}}});
  document.getElementById("metricsBox").innerHTML="";
}

/* =======================
   Timeline
======================= */
function plotTimeline(){
  if(!checkData()) return;
  const events=[];
  pilgrimsData.forEach(r=>{
    let y=r["Дата издания"];
    if(!y) return;
    y=y.toString().trim().replace(/[^\d]/g,"");
    if(y.length<3) return;
    const year=parseInt(y);
    if(isNaN(year)) return;
    events.push({year,title:(r["Название"]||"").replace(/\s+/g," ")});
  });
  events.sort((a,b)=>a.year-b.year);

  const yearCount={};
  const yData=events.map(e=>{ yearCount[e.year]=(yearCount[e.year]||0)+1; return yearCount[e.year]; });

  Plotly.newPlot("timelineChart",[{
    x:events.map(e=>e.year),
    y:yData,
    text:events.map(e=>e.title),
    mode:"markers",
    type:"scatter",
    marker:{size:12}
  }],{title:"Timeline публикаций", yaxis:{visible:false}});
}
</script>
</body>
</html>
